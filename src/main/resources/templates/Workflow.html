<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/Topbar.css}">
    <link rel="stylesheet" th:href="@{/css/Workflow.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>INTRANET</title>
</head>
<body>
<div id="topbar" th:replace="components/Topbar :: topbar"></div>

<h2>360 워크플로우</h2>

<div class="container">
    <nav>
        <ul class="menu">
            <li class="active"><a href="#" th:href="@{/user/created}">내가 작성</a></li>
            <li><a href="#" th:href="@{/user/approved}">내가 승인</a></li>
        </ul>
    </nav>

    <div class="content">
        <div class="workflow-tabs">
            <button class="tab-button active" th:classappend="${tab == 'my' ? ' active' : ''}">내 보관함</button>
            <button class="tab-button" th:classappend="${tab == 'create' ? ' active' : ''}" onclick="openEquipmentRequestForm()">작성</button>
        </div>
        <div class="workflow-content">
            <div class="section">
                <div class="section-header">
                    <h3>확인 필요 <span class="badge" th:text="${pendingCount}"></span></h3>
                </div>
                <div class="item" th:each="item : ${pendingItems}">
                    <span class="status pending" th:text="${item.approvalStatus == 'PENDING' ? '미승인' : '승인'}">확인-미승인</span>
                    <span class="description" th:text="${item.equipName}">비품 신청</span>
                    <span class="meta" th:text="${item.meta}"></span>
                </div>
            </div>
            <div class="section">
                <div class="section-header">
                    <h3>보관함</h3>
                </div>
                <div class="item" th:each="item : ${completedItems}">
                    <span class="status complete" th:text="${item.approvalStatus == 'PENDING' ? '미승인' : '승인'}">완료</span>
                    <span class="description" th:text="${item.equipName}">비품 신청</span>
                    <span class="meta" th:text="${item.meta}"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Equipment Request Modal -->
<div id="equipmentRequestModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="equipmentRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- 동적 내용이 로드 -->
            <div class="modal-header">
                <h5 class="modal-title" id="equipmentRequestModalLabel">비품 신청</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 폼 내용 -->
                <form id="equipmentRequestForm" th:action="@{/api/equipment-requests}" method="post" onsubmit="return handleFormSubmit(event)">
                    <div>
                        <label for="equipName">품명</label>
                        <input type="text" id="equipName" name="equipName" required>
                    </div>
                    <div>
                        <label for="equipInfo">상품 정보(링크)</label>
                        <input type="text" id="equipInfo" name="equipInfo">
                    </div>
                    <div>
                        <label for="equipAmount">수량</label>
                        <input type="number" id="equipAmount" name="equipAmount" required>
                    </div>
                    <div>
                        <label for="equipCost">단가</label>
                        <input type="number" id="equipCost" name="equipCost" required>
                    </div>
                    <div>
                        <label for="equipSumcost">금액</label>
                        <input type="number" id="equipSumcost" name="equipSumcost" required>
                    </div>
                    <div>
                        <label for="equipWhy">사유</label>
                        <textarea id="equipWhy" name="equipWhy" required></textarea>
                    </div>
                    <div>
                        <button type="submit">보내기</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary">신청</button>
            </div>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- 동적 내용이 로드 -->
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/modal.js}"></script>
<script>
    function openEquipmentRequestForm() {
        $('#equipmentRequestModal').modal('show');
    }

    function handleFormSubmit(event) {
        event.preventDefault();
        var form = document.getElementById('equipmentRequestForm');
        var formData = new FormData(form);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = function () {
            if (xhr.status === 200) {
                alert('완료되었습니다.');
                window.location.href = "/workflow";
            } else {
                alert('오류가 발생했습니다. 다시 시도해 주세요.');
            }
        };
        xhr.send(new URLSearchParams(formData).toString());
    }

    function openProfileModal(employeeId) {
        $('#profileModal .modal-content').load('/employee/profileModalContent?id=' + employeeId, function() {
            $('#profileModal').modal('show');
        });
    }
    // 각 탭 버튼에 이벤트 리스너 추가
    document.querySelectorAll('.tab-button').forEach(function(button) {
        button.addEventListener('click', function() {
            $('#equipmentRequestModal').modal('show');
        });
    });

    // 닫기 버튼에 이벤트 리스너 추가
    document.querySelectorAll('.close').forEach(function(button) {
        button.addEventListener('click', function() {
            $('#equipmentRequestModal').modal('hide');
        });
    });
</script>
</body>
</html>
